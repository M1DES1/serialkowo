// Dane serialu
const hazbinHotelData = {
    seasons: {
        1: [
            {
                number: 0,
                title: "Pilot",
                description: "Odcinek pilota≈ºowy",
                duration: "32:00",
                videoUrl: "https://github.com/M1DES1/serialkowo/raw/refs/heads/main/seriale/hazbinhotel/HAZBIN%20HOTEL%20(PILOT)%20%20Dubbing%20PL%20-%20BruDolina%20Studios%20(1080p,%20h264).mp4",
                language: "Dubbing PL"
            },
            {
                number: 1,
                title: "Uwertura",
                description: "Odcinek 1",
                duration: "24:00",
                videoUrl: "https://box-1192-e.vmwesa.online/hls/,xqx2onijybokjiqbtehs5lywurs7vpdsulxqknsludjyzzjm7q7536jhcuca,.urlset/master.m3u8",
                language: "Lektor PL"
            },
            {
                number: 2,
                title: "Radio zabi≈Ço gwiazdƒô",
                description: "Odcinek 2",
                duration: "22:00",
                videoUrl: "https://fs50.bigwarp.io/v/02/00483/6f85lhv3z1wu_x/x.mp4?t=5lD-05Ug5xlYFAQjTTRiEqgrhN9VsCPPYKD6k5I-634&s=1762965365&e=43200&f=2417121&sp=1000&i=0.0&kmnr=689547918047",
                language: "Lektor PL"
            },
            {
                number: 3,
                title: "Jajecznica",
                description: "Odcinek 3",
                duration: "25:00",
                videoUrl: "https://box-1245-w.vmwesa.online/hls/,xqx2pgajybokjiqbtehs5k2dwb2kywujxno7rbkd5t4yrt4rkl7mz2sxmp7q,.urlset/master.m3u8",
                language: "Lektor PL"
            },
            {
                number: 4,
                title: "Maskarada",
                description: "Odcinek 4",
                duration: "23:00",
                videoUrl: "https://fs51.bigwarp.io/v/01/00483/5xne159tmk1d_x/x.mp4?t=azDRmn5rO4HGD-YwJe93d4tOiTEfib8-4Mo1b6who3o&s=1762965505&e=43200&f=2417243&sp=1000&i=0.0&kmnr=435052582522",
                language: "Lektor PL"
            },
            {
                number: 5,
                title: "Pojedynek o ojcostwo",
                description: "Odcinek 5",
                duration: "26:00",
                videoUrl: "https://box-1163-t.vmwesa.online/hls/,xqx2pyyjybokjiqbtehs5kqrx3uzxpjntor2xbnkndxgisqdpgn7hrioavaa,.urlset/master.m3u8",
                language: "Lektor PL"
            },
            {
                number: 6,
                title: "Witamy w niebie",
                description: "Odcinek 6",
                duration: "24:00",
                videoUrl: "https://box-1183-rp.vmwesa.online/hls/,xqx2pxczybokjiqbtees5maoxtla56xqch65lig2hiktztsw7k4jt6mzwnda,.urlset/master.m3u8",
                language: "Lektor PL"
            },
            {
                number: 7,
                title: "Hejka, Rosie!",
                description: "Odcinek 7",
                duration: "25:00",
                videoUrl: "https://box-1181-pd.vmwesa.online/hls/,xqx2olqkybokjiqbtehs5pybxt4n5syawmvvyx4un57mapwyfasl2mcqnwza,.urlset/master.m3u8",
                language: "Lektor PL"
            },
            {
                number: 8,
                title: "Przedstawienie musi trwaƒá",
                description: "Odcinek 8",
                duration: "27:00",
                videoUrl: "https://fs69.bigwarp.io/v/01/02250/y4xep40vzit1_x/x.mp4?t=sYm5CeAcUn19DNlH0TUFy_r-rVWCRl5jQG8lf9goyQo&s=1762967723&e=43200&f=11252472&sp=1000&i=0.0&kmnr=513936365447",
                language: "Napisy PL"
            }
        ],
        2: [
            {
                number: 1,
                title: "Nowy Pentious",
                description: "Odcinek 1",
                duration: "24:00",
                videoUrl: "https://box-1183-rp.vmwesa.online/hls/,xqx2pikzybokjiqbtees56a44phsyhd36kz4ofnia4daenlqilksd62dmxxq,.urlset/master.m3u8",
                language: "Lektor PL"
            },
            {
                number: 2,
                title: "Gawƒôdziarz",
                description: "Odcinek 2",
                duration: "23:00",
                videoUrl: "https://box-1246-e.vmwesa.online/hls/,xqx2pjszybokjiqbtees5ja3xyih73wqebmen3p4xdsrjmxbdjrspanqrlqa,.urlset/master.m3u8",
                language: "Lektor PL"
            },
            {
                number: 3,
                title: "Hazbin Hotel za zamkniƒôtymi drzwiami",
                description: "Odcinek 3",
                duration: "25:00",
                videoUrl: "https://str39.vidoza.net/vod/v2/nvl4cbeejifeieno3widxh5mn2se7ka5sj2plj6pugmjpczauwbrb24uoeypu2hey4/v.mp4",
                language: "Lektor PL"
            },
            {
                number: 4,
                title: "Umowa stoi",
                description: "Odcinek 4",
                duration: "26:00",
                videoUrl: "https://box-1396-t10.vmeas.cloud/hls/,xqx2oljmyjokjiqbtevs5o2nuiocr6wygrdmplwah5axac5h27vbdngwclkq,.urlset/master.m3u8",
                language: "Lektor PL"
            },
            {
                number: 5,
                title: "Uciszeni",
                description: "Odcinek 5",
                duration: "24:00",
                videoUrl: "https://vef-doc-2ccd.transitto.online/hls/,xqx2objm7vokjiqbte2c5lce4c2gleeaebxl4utw4lbxlaitpp36xwjp4iaa,.urlset/master.m3u8",
                language: "Lektor PL"
            },
            {
                number: 6,
                title: "Wrzeszcz",
                description: "Odcinek 6",
                duration: "25:00",
                videoUrl: "https://fs37.bigwarp.io/v/01/02295/bwebgls0ul1r_x/x.mp4?t=lY2LNbq664PQOWnpYuKJur8aHwO_p-TBGrjfENsMUL8&s=1762966881&e=43200&f=11477415&sp=1000&i=0.0&kmnr=373982843175",
                language: "Lektor PL"
            }
        ]
    }
};

// Elementy DOM
const videoPlayer = document.getElementById('video-player');
const controlsOverlay = document.getElementById('controls-overlay');
const loadingSpinner = document.getElementById('loading-spinner');
const endScreen = document.getElementById('end-screen');
const episodesSidebar = document.getElementById('episodes-sidebar');
const progressFill = document.getElementById('progress-fill');
const progressThumb = document.getElementById('progress-thumb');
const progressBuffer = document.getElementById('progress-buffer');
const currentTimeEl = document.getElementById('current-time');
const totalTimeEl = document.getElementById('total-time');
const volumeSlider = document.getElementById('volume-slider');
const volumeBtn = document.querySelector('.volume-btn');
const playPauseBtn = document.getElementById('play-pause-btn');
const playPauseSmall = document.getElementById('play-pause-small');
const nextEpisodeBtn = document.getElementById('next-episode-btn');
const speedText = document.getElementById('speed-text');
const countdownEl = document.getElementById('countdown');

// Zmienne
let currentEpisode = 0;
let currentSeason = 1;
let isSeeking = false;
let isSidebarOpen = false;
let lastClickTime = 0;
let controlsTimeout;
let isMouseMoving = false;
let mouseMoveTimeout;
let countdownInterval;
const playbackRates = [0.75, 1, 1.25, 1.5, 2];
let currentSpeedIndex = 1;

// Inicjalizacja
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const episodeParam = urlParams.get('episode');
    const seasonParam = urlParams.get('season');
    
    if (episodeParam) {
        currentEpisode = parseInt(episodeParam);
    }
    if (seasonParam) {
        currentSeason = parseInt(seasonParam);
    }
    
    loadEpisode(currentEpisode, currentSeason);
    initEventListeners();
    initVolumeControl();
    initEpisodesSidebar();
});



function initEventListeners() {
    // Video events
    videoPlayer.addEventListener('loadstart', showLoading);
    videoPlayer.addEventListener('canplay', hideLoading);
    videoPlayer.addEventListener('waiting', showLoading);
    videoPlayer.addEventListener('playing', hideLoading);
    videoPlayer.addEventListener('timeupdate', updateProgress);
    videoPlayer.addEventListener('progress', updateBuffer);
    videoPlayer.addEventListener('ended', showEndScreen);
    videoPlayer.addEventListener('volumechange', updateVolumeUI);
    videoPlayer.addEventListener('play', updatePlayState);
    videoPlayer.addEventListener('pause', updatePlayState);
    videoPlayer.addEventListener('loadedmetadata', function() {
        totalTimeEl.textContent = formatTime(videoPlayer.duration);
    });
    
    // Error handling
    videoPlayer.addEventListener('error', function(e) {
        console.error('B≈ÇƒÖd wideo:', e);
        console.error('Kod b≈Çƒôdu:', videoPlayer.error);
        console.error('URL wideo:', videoPlayer.src);
        hideLoading();
        showManualDownloadOption();
    });
    
    // Mouse movement detection
    document.addEventListener('mousemove', function() {
        if (!isMouseMoving) {
            isMouseMoving = true;
            showControlsTemporarily();
        }
        
        clearTimeout(mouseMoveTimeout);
        mouseMoveTimeout = setTimeout(() => {
            isMouseMoving = false;
        }, 100);
    });
    
    // Click events
    videoPlayer.addEventListener('click', handleVideoClick);
    
    // Keyboard events
    document.addEventListener('keydown', handleKeyboard);
    
    // Progress bar events
    document.addEventListener('mousemove', handleProgressDrag);
    document.addEventListener('mouseup', stopSeeking);
}

// Pokazuj opcjƒô rƒôcznego pobrania je≈õli wideo nie dzia≈Ça
function showManualDownloadOption() {
    const errorMessage = document.createElement('div');
    errorMessage.style.cssText = `
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.9);
        color: white;
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        z-index: 100;
        border: 2px solid #e50914;
        max-width: 500px;
        width: 90%;
    `;
    
    const episode = getCurrentEpisode();
    errorMessage.innerHTML = `
        <h3>Problem z odtwarzaniem wideo</h3>
        <p>Wideo nie mo≈ºe byƒá odtworzone bezpo≈õrednio w przeglƒÖdarce.</p>
        <p>Mo≈ºesz:</p>
        <div style="margin: 20px 0;">
            <a href="${episode.videoUrl}" 
               download 
               style="background: #e50914; color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; display: inline-block; margin: 10px;">
               üì• Pobierz odcinek
            </a>
        </div>
        <p style="font-size: 0.9rem; color: #ccc;">
            Po pobraniu otw√≥rz plik w odtwarzaczu wideo na swoim urzƒÖdzeniu.
        </p>
    `;
    
    videoPlayer.parentElement.appendChild(errorMessage);
}

// Inicjalizacja kontroli g≈Ço≈õno≈õci
function initVolumeControl() {
    videoPlayer.volume = 1;
    volumeSlider.value = 1;
    updateVolumeIcon();
}

// Aktualizacja ikony g≈Ço≈õno≈õci
function updateVolumeIcon() {
    const volume = videoPlayer.volume;
    const isMuted = videoPlayer.muted || volume === 0;
    
    volumeBtn.classList.toggle('muted', isMuted);
    
    volumeBtn.querySelectorAll('.btn-icon').forEach(icon => {
        icon.style.display = 'none';
    });
    
    if (isMuted || volume === 0) {
        volumeBtn.querySelector('.volume-mute').style.display = 'block';
    } else if (volume < 0.5) {
        volumeBtn.querySelector('.volume-low').style.display = 'block';
    } else {
        volumeBtn.querySelector('.volume-high').style.display = 'block';
    }
}

// Inicjalizacja sidebar z odcinkami
function initEpisodesSidebar() {
    const sidebarContent = document.querySelector('.sidebar-content');
    sidebarContent.innerHTML = '';
    
    // Dodaj odcinki z obu sezon√≥w
    for (const season in hazbinHotelData.seasons) {
        const seasonEpisodes = hazbinHotelData.seasons[season];
        
        // Nag≈Ç√≥wek sezonu
        const seasonHeader = document.createElement('div');
        seasonHeader.className = 'season-header';
        seasonHeader.innerHTML = `<h4>Sezon ${season}</h4>`;
        sidebarContent.appendChild(seasonHeader);
        
        seasonEpisodes.forEach(episode => {
            const episodeItem = document.createElement('div');
            episodeItem.className = `episode-side-item ${episode.number === currentEpisode && parseInt(season) === currentSeason ? 'active' : ''}`;
            episodeItem.setAttribute('data-episode', episode.number);
            episodeItem.setAttribute('data-season', season);
            
            episodeItem.innerHTML = `
                <div class="episode-side-content">
                    <span class="episode-side-num">${episode.number.toString().padStart(2, '0')}</span>
                    <div class="episode-side-info">
                        <span class="episode-side-title">${episode.title}</span>
                        <span class="episode-side-duration">${episode.duration}</span>
                    </div>
                </div>
                <div class="episode-play-icon">‚ñ∂</div>
            `;
            
            episodeItem.addEventListener('click', function() {
                const episodeNumber = parseInt(this.getAttribute('data-episode'));
                const seasonNumber = parseInt(this.getAttribute('data-season'));
                changeEpisode(episodeNumber, seasonNumber);
            });
            
            sidebarContent.appendChild(episodeItem);
        });
    }
}

// Pobierz aktualny odcinek
function getCurrentEpisode() {
    return hazbinHotelData.seasons[currentSeason].find(ep => ep.number === currentEpisode);
}

// Pobierz nastƒôpny odcinek
function getNextEpisode() {
    const currentEpisodes = hazbinHotelData.seasons[currentSeason];
    const currentIndex = currentEpisodes.findIndex(ep => ep.number === currentEpisode);
    
    // Je≈õli jest nastƒôpny odcinek w tym sezonie
    if (currentIndex < currentEpisodes.length - 1) {
        return {
            episode: currentEpisodes[currentIndex + 1],
            season: currentSeason
        };
    }
    // Je≈õli to koniec sezonu, przejd≈∫ do pierwszego odcinka nastƒôpnego sezonu
    else if (currentSeason < Object.keys(hazbinHotelData.seasons).length) {
        const nextSeason = currentSeason + 1;
        const nextSeasonEpisodes = hazbinHotelData.seasons[nextSeason];
        if (nextSeasonEpisodes && nextSeasonEpisodes.length > 0) {
            return {
                episode: nextSeasonEpisodes[0],
                season: nextSeason
            };
        }
    }
    
    return null;
}

function loadEpisode(episodeNumber, seasonNumber) {
    const episodes = hazbinHotelData.seasons[seasonNumber];
    const episode = episodes.find(ep => ep.number === episodeNumber);
    
    if (episode) {
        showLoading();
        console.log('≈Åadowanie odcinka:', episodeNumber, 'Sezon:', seasonNumber);
        
        videoPlayer.src = episode.videoUrl;
        currentEpisode = episodeNumber;
        currentSeason = seasonNumber;
        
        updateEpisodeInfo(episodeNumber, seasonNumber);
        hideEndScreen();
        
        videoPlayer.load();
        
        videoPlayer.addEventListener('canplay', function onCanPlay() {
            videoPlayer.removeEventListener('canplay', onCanPlay);
            console.log('Wideo gotowe do odtwarzania');
            hideLoading();
        }, { once: true });
        
    } else {
        console.error('Nie znaleziono odcinka:', episodeNumber, 'Sezon:', seasonNumber);
    }
}

function handleVideoClick(event) {
    if (loadingSpinner.classList.contains('show')) {
        return;
    }
    
    const currentTime = new Date().getTime();
    const timeSinceLastClick = currentTime - lastClickTime;
    
    if (timeSinceLastClick < 300) {
        event.preventDefault();
        togglePlayPause();
        showDoubleClickPause();
    } else {
        togglePlayPause();
    }
    
    lastClickTime = currentTime;
    showControlsTemporarily();
}

function showDoubleClickPause() {
    const pauseEffect = document.createElement('div');
    pauseEffect.className = 'double-click-pause';
    pauseEffect.textContent = videoPlayer.paused ? '‚è∏' : '‚ñ∂';
    
    videoPlayer.parentElement.appendChild(pauseEffect);
    
    setTimeout(() => {
        pauseEffect.remove();
    }, 1000);
}

// Controls functions
function togglePlayPause() {
    if (loadingSpinner.classList.contains('show')) {
        return;
    }
    
    if (videoPlayer.paused) {
        videoPlayer.play().catch(error => {
            console.log('B≈ÇƒÖd odtwarzania:', error);
        });
    } else {
        videoPlayer.pause();
    }
    showControlsTemporarily();
}

function skipTime(seconds) {
    if (loadingSpinner.classList.contains('show')) {
        return;
    }
    
    videoPlayer.currentTime += seconds;
    showControlsTemporarily();
}

function toggleMute() {
    if (loadingSpinner.classList.contains('show')) {
        return;
    }
    
    videoPlayer.muted = !videoPlayer.muted;
    updateVolumeIcon();
    showControlsTemporarily();
}

function changeVolume(value) {
    if (loadingSpinner.classList.contains('show')) {
        return;
    }
    
    videoPlayer.volume = parseFloat(value);
    videoPlayer.muted = (videoPlayer.volume === 0);
    updateVolumeIcon();
    showControlsTemporarily();
}

function updateVolumeUI() {
    volumeSlider.value = videoPlayer.volume;
    updateVolumeIcon();
}

function toggleSpeed() {
    if (loadingSpinner.classList.contains('show')) {
        return;
    }
    
    currentSpeedIndex = (currentSpeedIndex + 1) % playbackRates.length;
    const speed = playbackRates[currentSpeedIndex];
    videoPlayer.playbackRate = speed;
    speedText.textContent = speed + 'x';
    showControlsTemporarily();
}

function toggleEpisodesList() {
    if (loadingSpinner.classList.contains('show')) {
        return;
    }
    
    isSidebarOpen = !isSidebarOpen;
    episodesSidebar.classList.toggle('open', isSidebarOpen);
    showControlsTemporarily();
}

function toggleFullscreen() {
    if (loadingSpinner.classList.contains('show')) {
        return;
    }
    
    if (!document.fullscreenElement) {
        videoPlayer.parentElement.requestFullscreen().catch(err => {
            console.log('B≈ÇƒÖd pe≈Çnego ekranu:', err);
        });
    } else {
        document.exitFullscreen();
    }
    showControlsTemporarily();
}

// Progress functions
function updateProgress() {
    if (!isSeeking && videoPlayer.duration) {
        const progress = (videoPlayer.currentTime / videoPlayer.duration) * 100;
        progressFill.style.width = progress + '%';
        progressThumb.style.left = progress + '%';
    }
    
    currentTimeEl.textContent = formatTime(videoPlayer.currentTime);
}

function updateBuffer() {
    if (videoPlayer.buffered.length > 0 && videoPlayer.duration) {
        const buffered = (videoPlayer.buffered.end(0) / videoPlayer.duration) * 100;
        progressBuffer.style.width = buffered + '%';
    }
}

function handleProgressClick(event) {
    if (loadingSpinner.classList.contains('show')) {
        return;
    }
    
    const progressContainer = event.currentTarget;
    const rect = progressContainer.getBoundingClientRect();
    const percent = (event.clientX - rect.left) / rect.width;
    videoPlayer.currentTime = percent * videoPlayer.duration;
    showControlsTemporarily();
}

function handleProgressDrag(event) {
    if (isSeeking) {
        const progressContainer = document.querySelector('.progress-container');
        const rect = progressContainer.getBoundingClientRect();
        let percent = (event.clientX - rect.left) / rect.width;
        percent = Math.max(0, Math.min(1, percent));
        
        progressFill.style.width = (percent * 100) + '%';
        progressThumb.style.left = (percent * 100) + '%';
    }
}

function stopSeeking() {
    if (isSeeking) {
        isSeeking = false;
        const percent = parseFloat(progressFill.style.width) / 100;
        videoPlayer.currentTime = percent * videoPlayer.duration;
    }
}

function formatTime(seconds) {
    if (isNaN(seconds)) return '0:00';
    
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

// UI controls visibility
function showControlsTemporarily() {
    if (loadingSpinner.classList.contains('show')) {
        return;
    }
    
    controlsOverlay.classList.add('visible');
    clearTimeout(controlsTimeout);
    
    if (!videoPlayer.paused) {
        controlsTimeout = setTimeout(() => {
            if (!isMouseMoving) {
                controlsOverlay.classList.remove('visible');
            }
        }, 2000);
    }
}

function updatePlayState() {
    const isPlaying = !videoPlayer.paused;
    const videoContainer = document.querySelector('.video-container');
    
    videoContainer.classList.toggle('video-playing', isPlaying);
    videoContainer.classList.toggle('paused', !isPlaying);
    document.querySelector('.play-btn').classList.toggle('video-playing', isPlaying);
    
    showControlsTemporarily();
}

function updateEpisodeInfo(episodeNumber, seasonNumber) {
    document.querySelectorAll('.episode-side-item').forEach(item => {
        item.classList.remove('active');
        const itemEpisode = parseInt(item.getAttribute('data-episode'));
        const itemSeason = parseInt(item.getAttribute('data-season'));
        
        if (itemEpisode === episodeNumber && itemSeason === seasonNumber) {
            item.classList.add('active');
        }
    });
    
    const nextEpisode = getNextEpisode();
    nextEpisodeBtn.disabled = !nextEpisode;
}

// Loading functions
function showLoading() {
    loadingSpinner.classList.add('show');
}

function hideLoading() {
    loadingSpinner.classList.remove('show');
}

// End screen functions z odliczaniem
function showEndScreen() {
    endScreen.classList.add('show');
    
    // Rozpocznij odliczanie
    let countdown = 10;
    countdownEl.textContent = countdown;
    
    countdownInterval = setInterval(() => {
        countdown--;
        countdownEl.textContent = countdown;
        
        if (countdown <= 0) {
            clearInterval(countdownInterval);
            playNextEpisode();
        }
    }, 1000);
}

function hideEndScreen() {
    endScreen.classList.remove('show');
    if (countdownInterval) {
        clearInterval(countdownInterval);
    }
}

function cancelAutoPlay() {
    hideEndScreen();
    window.location.href = 'index.html';
}

function replayEpisode() {
    videoPlayer.currentTime = 0;
    videoPlayer.play();
    hideEndScreen();
}

function playNextEpisode() {
    const nextEpisode = getNextEpisode();
    
    if (nextEpisode) {
        changeEpisode(nextEpisode.episode.number, nextEpisode.season);
    } else {
        // Je≈õli nie ma wiƒôcej odcink√≥w, wr√≥ƒá do strony g≈Ç√≥wnej
        window.location.href = 'index.html';
    }
    hideEndScreen();
}

function changeEpisode(episodeNumber, seasonNumber) {
    loadEpisode(episodeNumber, seasonNumber);
    if (isSidebarOpen) {
        toggleEpisodesList();
    }
}

// Keyboard controls
function handleKeyboard(event) {
    if (loadingSpinner.classList.contains('show')) {
        return;
    }
    
    if (event.target.tagName === 'INPUT') return;
    
    switch(event.key) {
        case ' ':
        case 'k':
            event.preventDefault();
            togglePlayPause();
            break;
        case 'f':
            event.preventDefault();
            toggleFullscreen();
            break;
        case 'm':
            event.preventDefault();
            toggleMute();
            break;
        case 'e':
        case 'E':
            event.preventDefault();
            toggleEpisodesList();
            break;
        case 'ArrowLeft':
            event.preventDefault();
            skipTime(-10);
            break;
        case 'ArrowRight':
            event.preventDefault();
            skipTime(10);
            break;
        case 'ArrowUp':
            event.preventDefault();
            changeVolume(Math.min(1, videoPlayer.volume + 0.1));
            break;
        case 'ArrowDown':
            event.preventDefault();
            changeVolume(Math.max(0, videoPlayer.volume - 0.1));
            break;
        case '>':
        case '.':
            event.preventDefault();
            toggleSpeed();
            break;
    }
}
